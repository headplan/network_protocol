# OAuth2.0

参考资料

> * [http://www.ruanyifeng.com/blog/2014/05/oauth\_2\_0.html](http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html)
> * [http://www.jianshu.com/p/0d0d415eb8d1](http://www.jianshu.com/p/0d0d415eb8d1)
> * [http://blog.csdn.net/seccloud/article/details/8192707](http://blog.csdn.net/seccloud/article/details/8192707)

#### **什么是OAuth协议**

OAuth是一个关于授权\(authorization\)的开放网络标准,在全世界得到广泛应用,目前的版本是2.0版.

OAuth\(开放授权\)是一个开放标准 , 允许第三方网站在用户授权的前提下访问在用户在服务商那里存储的各种信息 . 而这种授权无需将用户提供用户名和密码提供给该第三方网站 , OAuth允许用户提供一个令牌给第三方网站 , 一个令牌对应一个特定的第三方网站 , 同时该令牌只能在特定的时间内访问特定的资源 .

> **应用场景举例**
>
> 假如有一个"云冲印"的网站 , 可以将用户储存在Google的照片冲印出来 . 用户为了使用该服务 , 必须让"云冲印"读取自己储存在Google上的照片 . 问题是只有得到用户的授权 , Google才会同意"云冲印"读取这些照片 . 那么 , "云冲印"怎样获得用户的授权呢？
>
> 传统方法是 , 用户将自己的Google用户名和密码 , 告诉"云冲印" , 后者就可以读取用户的照片了 , 这样做的弊端 :
>
> * 应用为了后续的服务,会保存用户的密码.
> * 另一个应用需要部署密码登录.
> * 用户无法限制应用获取自己在另一个应用中获取资料,授权范围和有效期.
> * 用户只有修改密码,才能收回权限.
> * 用户授权是整体的,一个被破解,所有其他应用都会丢失.
>
> OAuth就是为了解决上面这些问题而诞生的 .

#### 名词定义

几个专用名词 :

* **Third-party application** - 第三方应用程序 , 又可以称为"客户端"\(client\) , 即前面例子中的"云冲印"
* **HTTP service** - HTTP服务提供商 , 我们简称其为"服务提供商" , 即前面例子中的Google
* **Resource Owner** - 资源所有者 , 这里我们称"用户"\(user\)
* **User Agent** - 用户代理 , 这里就是指浏览器
* **Authorization server** - 认证服务器 , 即服务提供商专门用来处理认证的服务器
* **Resource server** - 资源服务器 , 即服务提供商存放用户生成的资源的服务器 . 它与认证服务器 , 可以是同一台服务器 , 也可以是不同的服务器 . 

总结一下 : OAuth的作用就是让"客户端"安全可控地获取"用户"的授权 , 与"服务商提供商"进行互动

#### 原理与流程

OAuth在"客户端"与"服务提供商"之间 , 设置了一个授权层\(authorization layer\) . "客户端"不能直接登录"服务提供商" , 只能登录授权层 , 以此将用户与客户端区分开来 . "客户端"登录授权层所用的令牌\(token\) , 与用户的密码不同 . 用户可以在登录的时候 , 指定授权层令牌的权限范围和有效期 .

"客户端"登录授权层以后 , "服务提供商"根据令牌的权限范围和有效期 , 向"客户端"开放用户储存的资料 .

**图示运行流程**

![](/assets/oauth1.png)

（A）用户打开客户端以后，客户端要求用户给予授权。

（B）用户同意给予客户端授权。

（C）客户端使用上一步获得的授权，向认证服务器申请令牌。

（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。

（E）客户端使用令牌，向资源服务器申请获取资源。

（F）资源服务器确认令牌无误，同意向客户端开放资源。

通过这样一种方式 , 可以在用户无须输入密码的方式下 , 给予第三方权限访问信息 , 但是每次都需要用户给予一次授权 , 也就是有步骤A/B两步 , OAuth2.0引入**Refresh Token** , 在一次获取授权后 , 具备自动刷新token的功能 .

![](/assets/oauth2.png)

（A）用户同意给予客户端授权。

（B）认证服务器对客户端进行认证以后，同时返回Token和Refresh Token。

（C）客户端使用令牌，向资源服务器申请获取资源。

（D）资源服务器确认令牌无误，同意向客户端开放资源。

（E）客户端使用令牌，向资源服务器申请获取资源。

（F）令牌无效，返回错误。

（G）用Refresh Token请求认证服务器。

（H）获取新的Token和Refresh Token，在用户无感知的情况下进行Token刷新。

