# TCP/IP协议族

TCP/IP协议族 , 是一个分层多协议的通信体系 .

#### TCP/IP协议族体系结构以及主要协议

TCP/IP协议族是一个四层协议系统 , 自底而上分别是数据链路层 , 网络层 , 传输层和应用层 . 每一层完成不同的功能 , 且通过若干协议来实现 , 上层协议使用下层协议提供的服务 .

![](/assets/tcpip.png)**数据链路层**

数据链路层实现了网卡接口的网络驱动程序 , 用来处理数据在物理媒介上的传输\(例 , 以太网,令牌环等\) . 网络驱动程序隐藏了不同的物理网络的特性 , 给上层协议提供了一个统一的接口 .

数据链路层常用的协议 :

* ARP协议 - 地址解析协议\(Address Resolution Protocol\)
* RARP协议 - 逆\(反向\)地址解析协议\(Reverse Address Resolution Protocol\)

她们实现了IP地址和机器物理地址之间的相互转换 .

> 机器物理地址 - 通常是指MAC地址 , 以太网 , 令牌环和802.11无线网络都是用MAC地址

工作流程 :

网络层使用IP地址寻找一台机器 , 而数据链路层则使用物理地址寻找一台机器 . 所以网络层必须先将目标机器的IP地址转化成其物理地址 , 才能使用数据链路层提供的服务 , 这就是ARP协议的用途 . 而RARP协议仅用于一些无盘的网络工作站 , 因为缺乏存储设备 , 这类无盘工作站无法记录自己的IP地址 , 但是他们可以使用物理网卡上的物理地址来向服务器或者服务管理软件查询自己的IP地址 . 所以通常情况下这些物理管理者会存有这个网络上所有机器的物理地址到IP地址的映射 .

**网络层**

网络层实现数据包的选路和转发 .

WAN通常使用众多分级的路由器来连接分散的主机或LAN , 因此通信的两台主机一般不是直接相连的 , 而是通过多个中间节点 , 也就是路由器连接的 .

> WAN - 广域网\(Wide Area Network\) , 也叫远程网络
>
> LAN - 局域网

网络层的任务就是选定这些中间节点 , 以确定两台主机之间的通信路径 . 同时 , 网络层对上层协议隐藏了网络拓扑连接的细节 , 使得在传输层和网络应用层的通信看起来是双方直接相连的 .

> IP协议 - 因特网协议\(Internet Protocol\)
>
> ICMP协议 - 因特网控制报文协议\(Internet Control Message Protocol\)

工作流程 :

网络层最核心的协议是IP协议 . IP协议根据数据包的目的IP地址来决定如何投递 . 如果数据包不能直接发送给目标主机 , 那么IP协议就为它寻找一个合适的吓一跳\(next hop\)路由器 , 并将数据包交付给该路由器来转发 . 多次重复这一过程 , 让数据包最终达到目标主机 , 或者由于发送失败而被丢弃 , 由此可见 , IP协议是使用逐跳\(hop by hop\)的方式确定通信的路径 .

网络层另外一个重要的协议是ICMP协议 . 其是IP协议的重要补充 , 主要用于检测网络连接 , 使用报完格式 .

![](/assets/ICMP.png)8位类型字段用于区分报文类型 . 它将ICMP爆粉分为两大类 , 差错报文和查询报文 . 差错报文主要用来回应网络错误 , 比如目标不可到达\(类型值3\)和重定向\(类型值5\) . 查询报文用于查询网络信息 , 例如ping程序就是使用ICMP报文查看目标是否可到达的\(类型值是8\). 有的报文还使用8位代码字段来进一步细分不同的条件 . 需要指出的是 , ICMP协议并非严格意义上的网络层协议 , 因为它使用同一层的IP协议提供的服务 , 因为一般来说 , 上层协议会使用下层协议提供的服务 .

**传输层**

传输层为两台主机上的应用程序提供端到端的通信 . 与网络层使用的逐跳通信方式不同 , 传输层值关心通信的起始端和目的端 , 而不在乎数据包的中转过程 .

![](/assets/chuanshuceng.png)

如上图所示 , 垂直的实线箭头表示TCP/IP协议家族各层之间的实体通信 , 也就是说数据包沿着这些线传递的 , 水平的虚线箭头表示逻辑通信线路 . 图中还描述了不同的物理网络连接方法 . 数据链路层\(驱动程序\)封装了物理网络的电气细节 , 网络层封装了网络连接的细节 , 传输层则为应用程序封装了一条端到端的逻辑通信链路 , 负责数据的收发,链路的超时重连等 .

传输层协议主要有三个 :

* TCP协议 - 传输控制协议\(Transmission Control Protocol\)
* UDP协议 - 用户数据报协议\(User Datagram Protocol\)
* SCTP协议 - 流控制传输协议\(Stream Control Transmission Protocol\)

TCP协议工作流程

TCP协议为应用层提供可靠的,面向连接和基于流的服务 . 使用超时重传,数据确认等方式来确保数据包被正确的发送至目的端 , 因此TCP服务是可靠的 . 使用TCP协议通信的双方必须先建立TCP连接 , 并在内核中为该连接维持一些必要的数据结构 , 比如连接的状态,读写缓冲区以及各种定时器等 . 当通信结束时 , 双方必须关闭连接以释放这些内核数据 . TCP服务是基于流的 , 也就是说数据没有边界\(长度\)限制 , 可以不断的从通信的一端流入另一端 . 发送端可以逐个字节的向数据流中写入数据 , 接收端也可以逐个字节的将他们读出来 .

UDP协议工作流程

UDP协议与TCP协议完全相反 , 其为应用层提供不可靠无,无连接和基于数据报的服务 . 这里的不可靠意味着UDP协议无法保证数据从发送端正确的传送到目的端 . 如果数据在中途丢失 , 或者目的端通过数据校验发现数据错误而将其丢弃 , UDP协议只是简单的通知应用程序发送失败 . 所以 , 使用UDP协议的应用程序通常要自己处理数据确认,超时重传等逻辑 . UDP协议是无连接的 , 即通信双方不保持一个长久的联系 , 因此应用程序每次发送数据都要明确指定接收端的地址\(IP等信息\) . 基于数据报的服务 , 是相对于流的服务而言的 . 每个UDP数据报都有一个长度 , 接收端必须以该长度为最小单位将其所有内容一次性读出 , 否则数据将被截断 .

SCTP协议 - SCTP协议是一种相对较新的传输层协议 , 是为了因特网上传输电话信号而设计的 . 这里不过多讨论 , 可以参考其标准文档RFC 2960 .

**应用层**

应用层负责处理应用程序的逻辑 . 数据链路层,网络层和传输层负责处理网络通信细节 , 这部分必须即稳定又高效 , 因此它们都是在内和空间中实现的 . 而应用层则在用户空间实现 , 因为它负责处理众多逻辑 , 比如文件传输 , 名称查询和网络管理等 . 如果应用层也在内核中实现 , 会让内核变得非常庞大 . 当然 , 有少数服务器程序是在内核中实现的 , 这样代码就无需在用户空间和内核空间来回切换了\(例如数据的复制等\) , 可以提高工作效率 . 这里只讨论用户空间的网络编程 . 

