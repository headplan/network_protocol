# 封装,分用与测试网络

#### 封装

通过封装实现了上层协议使用下层协议提供的服务 . 应用程序数据在发送到物理上之前 , 将按着协议栈从上往下依次传递 . 每层协议都将在上层协议的基础上加上自己的头部信息\(有时还包括尾部信息\),以实现该层的功能 , 这个过程就成为封装 . 

![](/assets/fengzhuang.png)经过TCP封装后的数据成为TCP报文段 , 或简称为TCP段 . 前面提到过TCP协议为通信双方维持一个连接 , 并且在内核中存储相关数据 . 这部分数据中的TCP头信息和TCP内核缓冲区\(发送缓冲区或接收缓冲区\)数据一起构成了TCP报文段 . 

![](/assets/tcpbaowenduan.png)当发送端应用程序使用send\(或者write\)函数向一个TCP连接写入数据时 , 内核中的TCP模块首先把这些数据复制到与该连接对应的TCP内核发送缓冲区 , 然后TCP模块调用IP模块提供的服务 , 传递的参数包括TCP头部信息和TCP发送缓冲区中的数据 , 即TCP报文 . 

经过UDP封装后的数据称为UDP数据报\(UDP datagram\) . UDP对应用程序数据的封装与TCP类似 . 不同的是UDP不用为应用层数据保存副本 , 因为其提供的服务是不可靠的 . 当一个UDP数据报被成功发送会后 , UDP内核缓冲区中的该数据报就被丢弃了 . 如果应用程序检测到数据报未能被接收端正确的接收 , 并打算重发的时候 , 应用程序需要重新从用户空间将该数据报拷贝到UDP内核发送缓冲区中 . 

经过IP封装后的数据称为IP数据报\(IP datagram\) . IP数据报也包括头部信息和数据部分 , 其中数据部分就是一个TCP报文段 , UDP数据报或者是ICMP报文 . 

经过数据链路层封装的数据称为帧\(frame\) . 传输媒介不同 , 帧的类型也不同 . 比如 , 以太网上传输的是以太网帧\(ethernet frame\) , 而令牌环网络上传输的则是令牌环帧 . 

例如以太网帧 : 

使用6字节的目的物理地址和6字节的源物理地址来表示通信的双方等等 . 

![](/assets/yitaizhen.png)

